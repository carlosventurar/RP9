---
title: "Configurar webhooks de Stripe para procesar pagos"
excerpt: "Aprende cÃ³mo configurar webhooks de Stripe para automatizar el procesamiento de pagos y suscripciones."
category: "integrations"
tags: ["stripe", "webhook", "pagos", "integraciÃ³n"]
author: "MarÃ­a GonzÃ¡lez"
created_at: "2024-08-01"
updated_at: "2024-08-10"
---

# Configurar webhooks de Stripe para procesar pagos

Los webhooks de Stripe te permiten recibir notificaciones automÃ¡ticas cuando ocurren eventos en tu cuenta, como pagos exitosos, fallos de cobro, o suscripciones canceladas. En esta guÃ­a aprenderÃ¡s cÃ³mo configurarlos con RP9.

## Â¿Por quÃ© usar webhooks de Stripe?

Los webhooks son esenciales para:

- âœ… **Confirmar pagos** en tiempo real
- âœ… **Actualizar suscripciones** automÃ¡ticamente
- âœ… **Manejar fallos de cobro** y dunning
- âœ… **Sincronizar** datos entre Stripe y tu sistema
- âœ… **Enviar emails** de confirmaciÃ³n/recibo

## Eventos de Stripe mÃ¡s comunes

| Evento | DescripciÃ³n | CuÃ¡ndo usarlo |
|--------|-------------|---------------|
| `payment_intent.succeeded` | Pago exitoso | Confirmar Ã³rdenes, enviar recibos |
| `payment_intent.payment_failed` | Pago fallÃ³ | Notificar al cliente, reintentar |
| `customer.subscription.created` | Nueva suscripciÃ³n | Activar acceso, email bienvenida |
| `customer.subscription.updated` | SuscripciÃ³n modificada | Cambiar plan, actualizar acceso |
| `customer.subscription.deleted` | SuscripciÃ³n cancelada | Revocar acceso, email despedida |
| `invoice.payment_succeeded` | Factura pagada | Renovar suscripciÃ³n |
| `invoice.payment_failed` | Factura no pagada | Iniciar proceso de dunning |

## Paso 1: Crear webhook en RP9

### 1.1 Crear nuevo workflow

1. Ve a **Workflows** â†’ **Crear Nuevo**
2. Nombre: `Stripe Webhook Handler`
3. DescripciÃ³n: `Procesamiento de eventos de Stripe`

### 1.2 Configurar trigger webhook

1. Selecciona **"Webhook"** como trigger
2. Copia la URL generada (ej: `https://hooks.rp9.com/webhook/abc123def`)
3. **Importante**: Guarda esta URL, la necesitarÃ¡s en Stripe

### 1.3 Configurar validaciÃ³n de signature

Para seguridad, valida que el webhook viene de Stripe:

```javascript
// Nodo de validaciÃ³n de signature
const crypto = require('crypto');

// Obtener signature de headers
const signature = $input.all()[0].headers['stripe-signature'];
const endpointSecret = 'whsec_tu_endpoint_secret'; // Desde Stripe
const payload = JSON.stringify($input.all()[0].body);

// Validar signature
const elements = signature.split(',');
const signatureHash = elements.find(element => element.includes('v1')).split('=')[1];
const timestamp = elements.find(element => element.includes('t')).split('=')[1];

const expectedSignature = crypto
  .createHmac('sha256', endpointSecret)
  .update(timestamp + '.' + payload)
  .digest('hex');

if (signatureHash !== expectedSignature) {
  throw new Error('Invalid signature');
}

return { valid: true, event: $input.all()[0].body };
```

## Paso 2: Configurar webhook en Stripe

### 2.1 Acceder al Dashboard de Stripe

1. Ve a [dashboard.stripe.com](https://dashboard.stripe.com)
2. Navega a **Developers** â†’ **Webhooks**
3. Haz clic en **"Add endpoint"**

### 2.2 Configurar el endpoint

**URL del endpoint**: Pega la URL de RP9 que copiaste
```
https://hooks.rp9.com/webhook/abc123def
```

**Eventos a escuchar**: Selecciona los eventos que necesitas:

```bash
# Para e-commerce bÃ¡sico:
payment_intent.succeeded
payment_intent.payment_failed
customer.subscription.created
customer.subscription.updated
customer.subscription.deleted

# Para facturaciÃ³n avanzada:
invoice.payment_succeeded
invoice.payment_failed
invoice.upcoming
customer.created
customer.updated
```

### 2.3 Obtener signing secret

1. Una vez creado el webhook, copia el **Signing secret**
2. Se ve asÃ­: `whsec_1234567890abcdef...`
3. Lo necesitarÃ¡s para validar signatures

## Paso 3: Procesar eventos en RP9

### 3.1 Estructura del workflow

```mermaid
graph TD
    A[Webhook Trigger] --> B[Validar Signature]
    B --> C[Identificar Evento]
    C --> D{Tipo de Evento}
    D -->|payment_intent.succeeded| E[Confirmar Pago]
    D -->|payment_intent.failed| F[Manejar Fallo]
    D -->|subscription.created| G[Activar SuscripciÃ³n]
    D -->|subscription.deleted| H[Cancelar Acceso]
    E --> I[Enviar Email ConfirmaciÃ³n]
    F --> J[Notificar Fallo]
    G --> K[Email Bienvenida]
    H --> L[Email Despedida]
```

### 3.2 Nodo switch para eventos

Usa un nodo **Switch** para manejar diferentes tipos de eventos:

```javascript
// Switch basado en event.type
const eventType = $input.all()[0].body.type;

return [
  {
    // Route 0: Pagos exitosos
    condition: eventType === 'payment_intent.succeeded'
  },
  {
    // Route 1: Pagos fallidos  
    condition: eventType === 'payment_intent.payment_failed'
  },
  {
    // Route 2: Nueva suscripciÃ³n
    condition: eventType === 'customer.subscription.created'
  },
  {
    // Route 3: SuscripciÃ³n cancelada
    condition: eventType === 'customer.subscription.deleted'
  }
];
```

### 3.3 Procesar pago exitoso

Para `payment_intent.succeeded`:

```javascript
// Extraer datos del evento
const event = $input.all()[0].body;
const paymentIntent = event.data.object;

return {
  paymentId: paymentIntent.id,
  amount: paymentIntent.amount / 100, // De centavos a pesos
  currency: paymentIntent.currency,
  customerId: paymentIntent.customer,
  customerEmail: paymentIntent.receipt_email,
  status: paymentIntent.status,
  created: new Date(paymentIntent.created * 1000),
  metadata: paymentIntent.metadata
};
```

Luego puedes:
- Actualizar tu base de datos
- Enviar email de confirmaciÃ³n
- Activar el producto/servicio
- Generar factura

### 3.4 Manejar fallo de pago

Para `payment_intent.payment_failed`:

```javascript
const event = $input.all()[0].body;
const paymentIntent = event.data.object;

return {
  paymentId: paymentIntent.id,
  customerId: paymentIntent.customer,
  amount: paymentIntent.amount / 100,
  failureCode: paymentIntent.last_payment_error?.code,
  failureMessage: paymentIntent.last_payment_error?.message,
  declineCode: paymentIntent.last_payment_error?.decline_code,
  customerEmail: paymentIntent.receipt_email
};
```

Acciones recomendadas:
- Notificar al cliente del fallo
- Sugerir mÃ©todo de pago alternativo
- Programar reintento automÃ¡tico
- Actualizar estado del pedido

## Paso 4: Ejemplos de workflows completos

### 4.1 E-commerce simple

```yaml
# Workflow: E-commerce Payment Processing
Trigger: Stripe Webhook

1. Validar Signature
   - Verificar que viene de Stripe
   - Usar signing secret

2. Switch por Evento
   - payment_intent.succeeded â†’ Ruta A
   - payment_intent.payment_failed â†’ Ruta B

3A. Pago Exitoso:
   - Actualizar BD (marcar pedido como pagado)
   - Enviar email de confirmaciÃ³n
   - Notificar a fulfillment
   - Crear entrada en contabilidad

3B. Pago Fallido:
   - Marcar pedido como fallido
   - Enviar email con opciones de pago
   - Notificar al equipo de ventas
```

### 4.2 SaaS con suscripciones

```yaml
# Workflow: SaaS Subscription Management
Trigger: Stripe Webhook

1. Validar Signature

2. Switch por Evento:
   - customer.subscription.created â†’ Activar
   - customer.subscription.updated â†’ Modificar  
   - customer.subscription.deleted â†’ Cancelar
   - invoice.payment_failed â†’ Dunning

3. Activar SuscripciÃ³n:
   - Crear/actualizar usuario en BD
   - Asignar rol segÃºn plan
   - Enviar credenciales de acceso
   - Email de bienvenida

4. Modificar SuscripciÃ³n:
   - Actualizar plan en BD
   - Ajustar lÃ­mites/features
   - Email de confirmaciÃ³n cambio

5. Cancelar SuscripciÃ³n:
   - Marcar para cancelaciÃ³n al final del perÃ­odo
   - Revocar acceso si es inmediato
   - Email de despedida
   - Encuesta de cancelaciÃ³n
```

## Paso 5: Testing y debugging

### 5.1 Usar Stripe CLI para testing

Instala Stripe CLI:
```bash
# macOS
brew install stripe/stripe-cli/stripe

# Windows
# Descargar desde https://github.com/stripe/stripe-cli
```

Reenviar eventos a tu webhook local:
```bash
stripe listen --forward-to https://hooks.rp9.com/webhook/abc123def
```

Simular eventos:
```bash
# Simular pago exitoso
stripe trigger payment_intent.succeeded

# Simular fallo de pago
stripe trigger payment_intent.payment_failed

# Simular nueva suscripciÃ³n
stripe trigger customer.subscription.created
```

### 5.2 Logs y monitoreo en RP9

1. Ve a **Workflows** â†’ **Tu workflow** â†’ **Ejecuciones**
2. Revisa logs de cada ejecuciÃ³n
3. Configura alertas para fallos
4. Monitorea mÃ©tricas de Ã©xito

### 5.3 Debugging comÃºn

**Error: Invalid signature**
- Verifica el signing secret
- AsegÃºrate de usar el raw body
- Revisa que el timestamp no sea muy viejo

**Error: Timeout**  
- Stripe espera respuesta en 10 segundos
- Procesa async lo que puedas
- Responde 200 OK inmediatamente

**Eventos duplicados**
- Implementa idempotencia usando `event.id`
- Guarda IDs procesados en BD
- Ignora eventos ya procesados

## Paso 6: Mejores prÃ¡cticas

### 6.1 Seguridad

- âœ… **Siempre valida signatures** de Stripe
- âœ… **Usa HTTPS** en producciÃ³n
- âœ… **No expongas** signing secrets
- âœ… **Implementa rate limiting**
- âœ… **Loguea intentos** fallidos

### 6.2 Reliability

- âœ… **Responde 200 OK** rÃ¡pidamente  
- âœ… **Implementa idempotencia** con event ID
- âœ… **Maneja reintentos** de Stripe automÃ¡ticamente
- âœ… **Procesa async** tareas pesadas
- âœ… **Monitora fallos** y alertas

### 6.3 Escalabilidad

- âœ… **Usa queues** para alto volumen
- âœ… **Procesa por lotes** cuando posible
- âœ… **Implementa circuit breakers**
- âœ… **Monitorea performance**

## Recursos adicionales

### DocumentaciÃ³n oficial:
- [Stripe Webhooks Guide](https://stripe.com/docs/webhooks)
- [Event Types Reference](https://stripe.com/docs/api/events/types)
- [Webhook Signatures](https://stripe.com/docs/webhooks/signatures)

### Plantillas RP9:
- ğŸ›’ [E-commerce Payment Flow](./templates/ecommerce-payments)
- ğŸ’³ [SaaS Subscription Manager](./templates/saas-subscriptions)  
- ğŸ“§ [Email Automation for Payments](./templates/payment-emails)

### Videos:
- [Stripe Webhooks en 10 minutos](https://youtube.com/watch?v=stripe123)
- [Debugging Webhooks](https://youtube.com/watch?v=debug456)

## Â¿Necesitas ayuda?

Si tienes problemas con la integraciÃ³n:

- ğŸ’¬ **Chat**: Soporte tÃ©cnico L-V 9:00-17:00
- ğŸ“§ **Email**: stripe-help@rp9.com  
- ğŸ« **Ticket**: [Crear ticket especializado](../new?category=integrations)
- ğŸ‘¥ **Comunidad**: [Slack #stripe-integration](https://rp9-community.slack.com)

---

**â­ Â¿Te ayudÃ³ esta guÃ­a?** Tu feedback mejora nuestro contenido.